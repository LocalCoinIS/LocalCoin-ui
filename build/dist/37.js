(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{5217:function(e,t,a){"use strict";a.r(t);var n=a(0),o=a.n(n),r=a(6),s=a.n(r),i=a(1),c=a.n(i),l=a(73),u=a(4),d=a(305),m=a(333),_=a(11),h=a.n(_),p=a(66),v=a(14),g=a(8),b=a(7),y=a(99),f=a(52),E=a(17),w=a(21),x=a(2),k=a.n(x),O=a(118),j=a(13),A=a(9),I=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},N=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],n=!0,o=!1,r=void 0;try{for(var s,i=e[Symbol.iterator]();!(n=(s=i.next()).done)&&(a.push(s.value),!t||a.length!==t);n=!0);}catch(e){o=!0,r=e}finally{try{!n&&i.return&&i.return()}finally{if(o)throw r}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),S=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();var C=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e)),n=e.proxy.get("id"),o=e.proxy.get("name");return a.state={proxy_account_id:"1.2.5"===n?"":n,prev_proxy_account_id:"1.2.5"===n?"":n,current_proxy_input:"1.2.5"===n?"":o,witnesses:null,committee:null,vote_ids:s.a.Set(),proxy_vote_ids:s.a.Set(),lastBudgetObject:e.initialBudget.get("id"),workerTableIndex:e.viewSettings.get("workerTableIndex",1),all_witnesses:s.a.List(),all_committee:s.a.List()},a.onProxyAccountFound=a.onProxyAccountFound.bind(a),a.onPublish=a.onPublish.bind(a),a.onReset=a.onReset.bind(a),a._getVoteObjects=a._getVoteObjects.bind(a),a}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.a.Component),S(t,[{key:"componentWillMount",value:function(){l.a.getFinalFeeAsset(this.props.account,"account_update"),u.b.fetchAllWorkers(),this.getBudgetObject()}},{key:"componentDidMount",value:function(){this.updateAccountData(this.props),this._getVoteObjects(),this._getVoteObjects("committee")}},{key:"componentWillReceiveProps",value:function(e){if(e.account!==this.props.account){var t=e.proxy.get("id"),a={proxy_account_id:"1.2.5"===t?"":t};this.setState({prev_proxy_account_id:a.proxy_account_id}),this.updateAccountData(e,a)}this.getBudgetObject()}},{key:"updateAccountData",value:function(e){var t=this,a=e.account,n=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.state).proxy_account_id,o=u.b.getAccount(n),r=a.get("options"),i=o?o.get("options"):null,c=o?o.get("name"):"";"1.2.5"===n&&(n="",c="");var l=r.get("votes").toArray(),d=s.a.Set(l);u.b.getObjectsByVoteIds(l);var m=null,_=s.a.Set([]);if("1.2.5"!==n&&i){var h=i.get("votes").toArray();_=s.a.Set(h),u.b.getObjectsByVoteIds(h),m=Object(u.g)(u.b.getObjectByVoteID,h,1e4)}Promise.all([Object(u.g)(u.b.getObjectByVoteID,l,1e4),m]).then(function(e){var a=N(e,2),o=a[0],r=a[1];function i(e){var t=new s.a.List,a=new s.a.List,n=new s.a.Set;return e.forEach(function(e){var n=e.get("committee_member_account");n?a=a.push(n):(n=e.get("worker_account"))||(n=e.get("witness_account"))&&(t=t.push(n))}),{witnesses:t,committee:a,workers:n}}var l=i(o),u=l.witnesses,m=l.committee,h=l.workers,p=i(r||[]),v=p.witnesses,g=p.committee,b=p.workers,y={proxy_account_id:n,current_proxy_input:c,witnesses:u,committee:m,workers:h,proxy_witnesses:v,proxy_committee:g,proxy_workers:b,vote_ids:d,proxy_vote_ids:_,prev_witnesses:u,prev_committee:m,prev_workers:h,prev_vote_ids:d};t.setState(y)})}},{key:"isChanged",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.state;return e.proxy_account_id!==e.prev_proxy_account_id||e.witnesses!==e.prev_witnesses||e.committee!==e.prev_committee||!s.a.is(e.vote_ids,e.prev_vote_ids)}},{key:"_getVoteObjects",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"witnesses",a=arguments[1],n=this.state["all_"+t],o="witnesses"===t,r=void 0;if(a)r=parseInt(a[a.length-1].split(".")[2],10);else{a=[];var i=this.props.globalObject.get(o?"active_witnesses":"active_committee_members").sort(function(e,t){return parseInt(e.split(".")[2],10)-parseInt(t.split(".")[2],10)}).last()||"1."+(o?"6":"5")+".1";r=parseInt(i.split(".")[2],10);for(var c=1;c<=r+10;c++)a.push("1."+(o?"6":"5")+"."+c)}Object(u.g)(u.b.getObject,a,5e3,{}).then(function(i){if(e.state["all_"+t]=n.concat(s.a.List(i.filter(function(e){return!!e}).map(function(e){return e.get(o?"witness_account":"committee_member_account")}))),i[i.length-1]){a=[];for(var c=r+11;c<=r+20;c++)a.push("1."+(o?"6":"5")+"."+c);return e._getVoteObjects(t,a)}e.forceUpdate()})}},{key:"onPublish",value:function(){var e=this,t=this.props.account.toJS(),a={account:t.id},n={memo_key:t.options.memo_key},o=this.state.proxy_account_id;n.voting_account=o||"1.2.5",n.num_witness=this.state.witnesses.size,n.num_committee=this.state.committee.size,a.new_options=n,a.fee={amount:0,asset_id:l.a.getFinalFeeAsset(t.id,"account_update")};var r=this.state.vote_ids,s=this._getWorkerArray(),i=new Date;function c(e,t){return e.includes(t)&&(e=e.delete(t)),e}s.forEach(function(e){e&&(new Date(e.get("work_end_date"))<=i&&(r=c(r,e.get("vote_for"))),r=c(r,e.get("vote_against")))}),Object(u.g)(u.b.getWitnessById,this.state.witnesses.toArray(),4e3).then(function(t){var a=t.map(function(e){return e.get("vote_id")});return Promise.all([Promise.resolve(a),Object(u.g)(u.b.getCommitteeMemberById,e.state.committee.toArray(),4e3)])}).then(function(e){a.new_options.votes=e[0].concat(e[1].map(function(e){return e.get("vote_id")})).concat(r.filter(function(e){return"2"===e.split(":")[0]}).toArray()).sort(function(e,t){var a=e.split(":"),n=t.split(":");return parseInt(a[1],10)-parseInt(n[1],10)}),y.a.updateAccount(a)})}},{key:"onReset",value:function(){var e=this,t=this.state;this.refs.voting_proxy&&this.refs.voting_proxy.refs.bound_component&&this.refs.voting_proxy.refs.bound_component.onResetProxy(),this.setState({proxy_account_id:t.prev_proxy_account_id,current_proxy_input:t.prev_proxy_input,witnesses:t.prev_witnesses,committee:t.prev_committee,workers:t.prev_workers,vote_ids:t.prev_vote_ids},function(){e.updateAccountData(e.props)})}},{key:"onAddItem",value:function(e,t){var a={};a[e]=this.state[e].push(t),this.setState(a)}},{key:"onRemoveItem",value:function(e,t){var a={};a[e]=this.state[e].filter(function(e){return e!==t}),this.setState(a)}},{key:"onChangeVotes",value:function(e,t){var a={};a.vote_ids=this.state.vote_ids,e.length&&e.forEach(function(e){a.vote_ids=a.vote_ids.add(e)}),t&&t.forEach(function(e){a.vote_ids=a.vote_ids.delete(e)}),this.setState(a)}},{key:"validateAccount",value:function(e,t){return t?"witnesses"===e?Object(u.g)(u.b.getWitnessById,[t.get("id")],3e3).then(function(e){return e[0]?null:"Not a witness"}):"committee"===e?Object(u.g)(u.b.getCommitteeMemberById,[t.get("id")],3e3).then(function(e){return e[0]?null:"Not a committee member"}):null:null}},{key:"onProxyChange",value:function(e){var t=u.b.getAccount(e);(!t||t&&t.get("id")!==this.state.proxy_account_id)&&this.setState({proxy_account_id:"",proxy_witnesses:s.a.Set(),proxy_committee:s.a.Set(),proxy_workers:s.a.Set()}),this.setState({current_proxy_input:e})}},{key:"onProxyAccountFound",value:function(e){var t=this;this.setState({proxy_account_id:e?e.get("id"):""},function(){t.updateAccountData(t.props)})}},{key:"onClearProxy",value:function(){this.setState({proxy_account_id:""})}},{key:"_getTotalVotes",value:function(e){return parseInt(e.get("total_votes_for"),10)-parseInt(e.get("total_votes_against"),10)}},{key:"getBudgetObject",value:function(){var e=this,t=this.state.lastBudgetObject,a=void 0;a=u.b.getObject(t);var n=parseInt(t.split(".")[2],10);if(a){var o=a.get("time");/Z$/.test(o)||(o+="Z");var r=new Date,s=n+Math.floor((r-new Date(o).getTime())/1e3/60/60)-1;if(n>=s)return;var i="2.13."+Math.max(n,s),c=parseInt(i.split(".")[2],10);Object(u.g)(u.b.getObject,[i],void 0,{}).then(function(t){null===N(t,1)[0]?e.setState({lastBudgetObject:"2.13."+(c-1)}):(A.a.setLastBudgetObject(i),e.setState({lastBudgetObject:i}))})}else{var l="2.13."+(n-1);Object(u.g)(u.b.getObject,[l],void 0,{}).then(function(t){null===N(t,1)[0]?e.setState({lastBudgetObject:"2.13."+(n-2)},e.getBudgetObject):(A.a.setLastBudgetObject(l),e.setState({lastBudgetObject:l}))})}}},{key:"_getWorkerArray",value:function(){var e=[];return u.b.workers.forEach(function(t){var a=u.b.getObject(t,!1,!1);a&&e.push(a)}),e}},{key:"_setWorkerTableIndex",value:function(e){this.setState({workerTableIndex:e})}},{key:"_renderRadioButton",value:function(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return o.a.createElement("label",{className:"radio"},o.a.createElement("input",{className:"radio__input",type:"radio",name:"dashboard-filters",onChange:t,checked:a}),o.a.createElement("span",{className:"radio__styled"}),o.a.createElement("span",{className:"radio__label"},e))}},{key:"render",value:function(){var e=this,t=this.state.workerTableIndex,a=this.props.settings.get("unit")||"1.3.0",n=!!this.state.proxy_account_id,r=h()("btn large inverted",{disabled:!this.isChanged()}),s=this.props.globalObject,i=void 0;this.state.lastBudgetObject&&(i=u.b.getObject(this.state.lastBudgetObject));var l=0,_=s?parseInt(s.getIn(["parameters","worker_budget_per_day"]),10):0;i&&(_=Math.min(24*i.getIn(["record","worker_budget"]),_),l=Math.min(24*i.getIn(["record","worker_budget"]),_));var v=new Date,g=this._getWorkerArray(),y=0,x=g.filter(function(e){return!!e&&(new Date(e.get("work_end_date")+"Z")>v&&new Date(e.get("work_begin_date")+"Z")<=v)}).sort(function(t,a){return e._getTotalVotes(a)-e._getTotalVotes(t)}).map(function(t,r){var s=parseInt(t.get("daily_pay"),10);_-=s;var i=t.get("total_votes_for")-t.get("total_votes_against");return _<=0&&!y&&(y=i),y&&i<y?null:o.a.createElement(d.a,{preferredUnit:a,rest:_+s,rank:r+1,key:t.get("id"),worker:t.get("id"),vote_ids:e.state[n?"proxy_vote_ids":"vote_ids"],onChangeVotes:e.onChangeVotes.bind(e),proxy:n,voteThreshold:y})}).filter(function(e){return!!e}),A=g.filter(function(e){if(!e)return!1;var t=e.get("total_votes_for")-e.get("total_votes_against");return new Date(e.get("work_end_date")+"Z")>v&&t<y||new Date(e.get("work_begin_date")+"Z")>v}).sort(function(t,a){return e._getTotalVotes(a)-e._getTotalVotes(t)}).map(function(t,r){return o.a.createElement(d.a,{preferredUnit:a,rest:0,rank:r+1,key:t.get("id"),worker:t.get("id"),vote_ids:e.state[n?"proxy_vote_ids":"vote_ids"],onChangeVotes:e.onChangeVotes.bind(e),proxy:n,voteThreshold:y})}),I=g.filter(function(e){return!!e&&new Date(e.get("work_end_date"))<=v}).sort(function(t,a){return e._getTotalVotes(a)-e._getTotalVotes(t)}).map(function(t,r){return o.a.createElement(d.a,{preferredUnit:a,rest:0,rank:r+1,key:t.get("id"),worker:t.get("id"),vote_ids:e.state[n?"proxy_vote_ids":"vote_ids"],onChangeVotes:e.onChangeVotes.bind(e),proxy:n,voteThreshold:y})}),N=o.a.createElement("span",{style:{float:"right"}},o.a.createElement("button",{className:h()(r,{success:this.isChanged()}),onClick:this.onPublish,tabIndex:4,disabled:!this.isChanged()},o.a.createElement(c.a,{content:"account.votes.publish"})),o.a.createElement("button",{className:r,onClick:this.onReset,tabIndex:8,disabled:!this.isChanged()},o.a.createElement(c.a,{content:"account.perm.reset"}))),S=o.a.createElement("div",{style:{width:"100%",maxWidth:350}},o.a.createElement(f.a,{hideImage:!0,account:this.state.current_proxy_input,accountName:this.state.current_proxy_input,onChange:this.onProxyChange.bind(this),onAccountChanged:this.onProxyAccountFound,typeahead:!0,tabIndex:1,placeholder:"Proxy not set"},o.a.createElement("span",{style:{paddingLeft:5,position:"relative",top:-1,display:n?"":"none"}},o.a.createElement(E.a,{name:"locked",title:"icons.locked.action",size:"1x"})),o.a.createElement("span",{style:{paddingLeft:5,position:"relative",top:9,display:n?"none":""}},o.a.createElement(b.b,{to:"/help/voting"},o.a.createElement(E.a,{name:"question-circle",title:"icons.question_circle",size:"1x"}))))),C=(o.a.createElement("div",{className:"inline-block",style:{float:"right",visibility:this.isChanged()?"visible":"hidden",color:"red",padding:"0.85rem",fontSize:"0.9rem"}},o.a.createElement(c.a,{content:"account.votes.save_finish"})),[{title:"explorer.witnesses.title",content:o.a.createElement("div",{className:"witnesses"},o.a.createElement("div",{className:"dashboard__actions"},o.a.createElement("div",{className:"container-fluid"},o.a.createElement("div",{className:"row"},o.a.createElement("div",{className:"col-xl-10 col-lg-12"},S),o.a.createElement("div",{className:"col-xl-2 col-lg-6"},N)))),o.a.createElement(m.a,{type:"witness",label:"account.votes.add_witness_label",items:this.state.all_witnesses,validateAccount:this.validateAccount.bind(this,"witnesses"),onAddItem:this.onAddItem.bind(this,"witnesses"),onRemoveItem:this.onRemoveItem.bind(this,"witnesses"),tabIndex:n?-1:2,supported:this.state[n?"proxy_witnesses":"witnesses"],withSelector:!1,active:s.get("active_witnesses"),proxy:this.state.proxy_account_id}))},{title:"explorer.committee_members.title",content:o.a.createElement("div",{className:"committee"},o.a.createElement("div",{className:"dashboard__actions"},o.a.createElement("div",{className:"container-fluid"},o.a.createElement("div",{className:"row"},o.a.createElement("div",{className:"col-xl-10 col-lg-12"},S),o.a.createElement("div",{className:"col-xl-2 col-lg-6"},N)))),o.a.createElement(m.a,{type:"committee",label:"account.votes.add_committee_label",items:this.state.all_committee,validateAccount:this.validateAccount.bind(this,"committee"),onAddItem:this.onAddItem.bind(this,"committee"),onRemoveItem:this.onRemoveItem.bind(this,"committee"),tabIndex:n?-1:3,supported:this.state[n?"proxy_committee":"committee"],withSelector:!1,active:s.get("active_committee_members"),proxy:this.state.proxy_account_id}))},{title:"account.votes.workers_short",content:o.a.createElement("div",{className:"workers"},o.a.createElement("div",{className:"container-fluid"},o.a.createElement("div",{className:"row"},o.a.createElement("div",{className:"col-xs-12"},N))),o.a.createElement("div",{className:"dashboard__actions"},o.a.createElement("div",{className:"container-fluid"},o.a.createElement("div",{className:"row"},o.a.createElement("div",{className:"col-xl-3 col-lg-6"},S),o.a.createElement("div",{className:"col-xl-9 col-lg-12"},o.a.createElement("div",{className:"dashboard__actions__filters"},this._renderRadioButton(k.a.translate("account.votes.new",{count:A.length}),this._setWorkerTableIndex.bind(this,0),!(0!==t)),this._renderRadioButton(k.a.translate("account.votes.active",{count:x.length}),this._setWorkerTableIndex.bind(this,1),!(1!==t))),o.a.createElement("button",{className:"btn large inverted"},o.a.createElement(b.b,{to:"/create-worker"},o.a.createElement(c.a,{content:"account.votes.create_worker"}))))))),o.a.createElement("div",{className:"dashboard__adaptive"},o.a.createElement("table",null,2===t?null:0===t?o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null),o.a.createElement("th",{colSpan:"3",style:{textAlign:"left"}},o.a.createElement(c.a,{content:"account.votes.threshold"})),o.a.createElement("th",{style:{textAlign:"right"}},o.a.createElement(j.a,{decimalOffset:5,hide_asset:!0,amount:y,asset:"1.3.0"})),o.a.createElement("th",{colSpan:"3"})),o.a.createElement("tr",null,o.a.createElement("th",{style:{border:"none",backgroundColor:"transparent"}}))):o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null),o.a.createElement("th",{colSpan:"4",style:{textAlign:"left"}},o.a.createElement(c.a,{content:"account.votes.total_budget"})," ","(",o.a.createElement(w.a,{name:a}),")"),o.a.createElement("th",{colSpan:"2",className:"hide-column-small"}),o.a.createElement("th",{style:{textAlign:"right"}},s?o.a.createElement(O.b,{hide_asset:!0,fromAsset:"1.3.0",toAsset:a,amount:l}):null),o.a.createElement("th",{className:"hide-column-small"})),o.a.createElement("tr",null,o.a.createElement("th",{style:{border:"none",backgroundColor:"transparent"}}))),o.a.createElement("thead",null,o.a.createElement("tr",null,2===t?null:o.a.createElement("th",{style:{textAlign:"right"}},o.a.createElement(c.a,{content:"account.votes.line"})),o.a.createElement("th",{style:{textAlign:"center"}},o.a.createElement(c.a,{content:"account.user_issued_assets.id"})),o.a.createElement("th",{style:{textAlign:"left"}},o.a.createElement(c.a,{content:"account.user_issued_assets.description"})),o.a.createElement("th",{style:{textAlign:"right"},className:"hide-column-small"},o.a.createElement(c.a,{content:"account.votes.total_votes"})),0===t?o.a.createElement("th",{style:{textAlign:"right"}},o.a.createElement(c.a,{content:"account.votes.missing"})):null,o.a.createElement("th",null,o.a.createElement(c.a,{content:"explorer.workers.period"})),2===t||0===t?null:o.a.createElement("th",{style:{textAlign:"right"},className:"hide-column-small"},o.a.createElement(c.a,{content:"account.votes.funding"})),o.a.createElement("th",{style:{textAlign:"right"},className:"hide-column-small"},o.a.createElement(c.a,{content:"account.votes.daily_pay"}),o.a.createElement("div",{style:{paddingTop:5,fontSize:"0.8rem"}},"(",o.a.createElement(w.a,{name:a}),")")),2===t||0===t?null:o.a.createElement("th",{style:{textAlign:"right"}},o.a.createElement(c.a,{content:"explorer.witnesses.budget"}),o.a.createElement("div",{style:{paddingTop:5,fontSize:"0.8rem"}},"(",o.a.createElement(w.a,{name:a}),")")),o.a.createElement("th",null,o.a.createElement(c.a,{content:"account.votes.toggle"})))),o.a.createElement("tbody",null,0===t?A:1===t?x:I))))}]);return o.a.createElement("div",{className:"voting-container"},o.a.createElement(p.a,{items:C,inner:!0,hashByConten:!0,dashboardTabsClass:"dashboard__tabs permissions small voting-tabs"}))}}]),t}();C.propTypes={initialBudget:g.a.ChainObject.isRequired,globalObject:g.a.ChainObject.isRequired,proxy:g.a.ChainAccount.isRequired},C.defaultProps={globalObject:"2.0.0"},C=Object(v.a)(C);t.default=function(e){return o.a.createElement(C,I({},e,{initialBudget:A.a.getLastBudgetObject()}))}}}]);